{% extends "base.html" %}

{% block title %}Term: {{ term.nickname }} ({{ term.season }} {{ term.year }}){% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-xl border border-gray-200">
    <div class="flex flex-col space-y-4 sm:flex-row sm:justify-between sm:items-center sm:space-y-0 mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Term: {{ term.nickname }} ({{ term.season }} {{ term.year }})</h1>
            <p class="text-lg text-gray-700 mb-2">School: {{ term.school_name }}</p>
            {% if term.start_date and term.end_date %}
            <p class="text-lg text-gray-700 mb-2">{{ term.start_date.strftime('%b %-d') }} - {{ term.end_date.strftime('%b %-d, %Y') }}</p>
            {% endif %}
        </div>

        <div class="flex flex-col space-y-4 sm:space-y-0 sm:space-x-4 sm:flex-row sm:items-start">
            <!-- Canvas Integration Section for Term -->
            {% if current_user.canvas_base_url and current_user.canvas_access_token %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-3 sm:mb-0">
                        <h3 class="text-lg font-semibold text-blue-800">Canvas Sync</h3>
                        <p class="text-sm text-blue-600">Sync this term's Canvas data</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button type="button" onclick="startCanvasSync('term', {{ term.id }})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-300 flex items-center">
                            <i class="fas fa-sync mr-2"></i>Sync Term from Canvas
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Term Actions Menu -->
            <div class="relative">
                <button id="termActionsMenuBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md transition duration-300 shadow-sm flex items-center justify-center h-11 w-full sm:w-auto">
                    <i class="fas fa-cog mr-2"></i>Term Actions
                    <i class="fas fa-chevron-down ml-2"></i>
                </button>
                <div id="termActionsMenuPopover" class="absolute right-0 mt-2 w-64 bg-white border border-gray-200 rounded-md shadow-lg z-20 hidden">
                    <div class="py-1">
                        <!-- Export Options -->
                        <div class="px-4 py-2">
                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Export Data</div>
                        </div>
                        <button onclick="exportTermData('csv', {{ term.id }})" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                            <i class="fas fa-file-csv mr-3 text-green-500"></i>Export as CSV
                        </button>
                        <button onclick="exportTermData('excel', {{ term.id }})" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                            <i class="fas fa-file-excel mr-3 text-green-600"></i>Export as Excel
                        </button>
                        <button onclick="exportTermData('pdf', {{ term.id }})" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                            <i class="fas fa-file-pdf mr-3 text-red-500"></i>Export as PDF Report
                        </button>
                        
                        <!-- Analytics Options -->
                        <div class="border-t border-gray-100"></div>
                        <div class="px-4 py-2">
                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Analytics</div>
                        </div>
                        <a href="{{ url_for('main.dashboard') }}?term_id={{ term.id }}" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                            <i class="fas fa-chart-line mr-3 text-purple-500"></i>Term Analytics
                        </a>
                        <button onclick="generateTermPredictions({{ term.id }})" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                            <i class="fas fa-crystal-ball mr-3 text-blue-500"></i>Grade Predictions
                        </button>
                        
                        <!-- Bulk Operations -->
                        <div class="border-t border-gray-100"></div>
                        <div class="px-4 py-2">
                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Bulk Operations</div>
                        </div>
                        <button onclick="sendTermReminders({{ term.id }})" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                            <i class="fas fa-bell mr-3 text-yellow-500"></i>Send Reminders
                        </button>
                        <button onclick="exportAllGrades({{ term.id }})" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                            <i class="fas fa-download mr-3 text-indigo-500"></i>Export All Grades
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Canvas Sync Progress Section -->
    <div class="mb-6 bg-white shadow-lg rounded-lg" id="canvas-progress-section" style="display: none;">
        <div class="border-b border-gray-200 px-6 py-4">
            <h2 class="text-lg font-semibold text-gray-900">Canvas Sync Progress</h2>
        </div>
        <div class="px-6 py-4">
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-600">Progress</span>
                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <span><i class="fas fa-clock"></i> <span id="canvas-elapsed-time">0.0s</span></span>
                        <span>Items: <span id="canvas-progress-items">0 / 0</span></span>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-6">
                    <div class="bg-blue-600 h-6 rounded-full transition-all duration-300 flex items-center justify-center" 
                         id="canvas-progress-bar" 
                         style="width: 0%;">
                        <span class="text-white text-sm font-medium" id="canvas-progress-text">0%</span>
                    </div>
                </div>
            </div>
            <div class="mb-2">
                <span class="text-sm text-gray-600">
                    <i class="fas fa-info-circle"></i> 
                    Status: <span id="canvas-current-operation" class="font-medium">Ready</span>
                </span>
            </div>
            <div id="canvas-error-section" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4" style="display: none;">
                <h6 class="text-yellow-800 font-medium mb-2">
                    <i class="fas fa-exclamation-triangle"></i> Errors:
                </h6>
                <ul id="canvas-error-list" class="text-yellow-700 text-sm list-disc pl-5"></ul>
            </div>
        </div>
    </div>

    <div class="mb-8 p-4 bg-blue-50 rounded-md border border-blue-200">
        <h2 class="text-xl font-semibold text-blue-800 mb-2">Term Summary</h2>
        <p class="text-lg text-blue-700">Overall Term GPA: <span class="font-bold">
            {%- set safe_gpa = term_gpa if term_gpa is not none and term_gpa != 'undefined' else none -%}
            {%- if safe_gpa is not none -%}
                {{ "%.2f"|format(safe_gpa|float(0)) }}
            {%- else -%}
                N/A
            {%- endif -%}
        </span></p>
    </div>

    {% if campus_closures %}
    <div class="mb-8 mt-4 p-4 bg-yellow-50 rounded-md border border-yellow-200">
        <h2 class="text-xl font-semibold text-yellow-800 mb-2">Campus Closures</h2>
        <ul class="list-disc list-inside text-yellow-700">
            {% for closure in campus_closures %}
            <li>{{ closure.date.strftime('%Y-%m-%d') }}: {{ closure.reason }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if campus_closures %}
    <div class="mb-8 mt-4 p-4 bg-yellow-50 rounded-md border border-yellow-200">
        <h2 class="text-xl font-semibold text-yellow-800 mb-2">Campus Closures</h2>
        <ul class="list-disc list-inside text-yellow-700">
            {% for closure in campus_closures %}
            <li>{{ closure.date.strftime('%Y-%m-%d') }}: {{ closure.reason }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="mb-6 sm:mb-8">
        <h2 class="text-xl sm:text-2xl font-semibold text-gray-700 mb-3 sm:mb-4">Add New Course to {{ term.nickname }}</h2>
        <form action="{{ url_for('main.add_course', term_id=term.id) }}" method="POST" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <!-- Mobile-friendly grid: stack on small screens, 2x2 on medium, 4 columns on large -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="course_name" class="block text-sm font-medium text-gray-700 mb-1">Course:</label>
                    <input type="text" step="0.5" id="course_name" name="course_name" placeholder="Course Name" required
                           class="w-full p-3 sm:p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base min-h-[44px]">
                </div>
                <div>
                    <label for="credits" class="block text-sm font-medium text-gray-700 mb-1">Credits:</label>
                    <input type="number" step="0.5" id="credits" name="credits" placeholder="Credits" required
                           class="w-full p-3 sm:p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base min-h-[44px]">
                </div>
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <input type="checkbox" id="is_weighted" name="is_weighted" value="True"
                           class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="is_weighted" class="text-sm font-medium text-gray-700">Is Weighted</label>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <input type="checkbox" id="is_category" name="is_category" value="True"
                           class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="is_category" class="text-sm font-medium text-gray-700">Is Category</label>
                </div>
            </div>
           <div class="mt-4">
            <div id="grade_categories_section" style="display: none;">
                <h3 class="text-xl font-semibold text-gray-700 mb-3" id="categories_section_title">Grade Categories for this Course</h3>
                <div id="categories_container" class="space-y-3">
                    <!-- Dynamic category inputs will go here -->
                </div>
                <button type="button" id="add_category_field"
                        class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition duration-300 shadow-sm">
                    Add Category Field
                </button>
            </div>

            <div>
                <button type="submit"
                        class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-md font-semibold transition duration-300 ease-in-out shadow-md">
                    Add Course
                </button>
            </div>
        </form>
    </div>

    <div class="mb-6 sm:mb-8">
        <h2 class="text-xl sm:text-2xl font-semibold text-gray-700 mb-3 sm:mb-4">Courses in this Term</h2>
        {% if courses %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-{{ [courses|length, 4]|min }} gap-4">
                {% set bg_colors = ['bg-red-100', 'bg-blue-100', 'bg-green-100', 'bg-yellow-100', 'bg-purple-100', 'bg-pink-100', 'bg-indigo-100', 'bg-teal-100', 'bg-orange-100', 'bg-cyan-100', 'bg-lime-100', 'bg-amber-100'] %}
                {% set text_colors = ['text-red-800', 'text-blue-800', 'text-green-800', 'text-yellow-800', 'text-purple-800', 'text-pink-800', 'text-indigo-800', 'text-teal-800', 'text-orange-800', 'text-cyan-800', 'text-lime-800', 'text-amber-800'] %}
                {% set hover_colors = ['hover:bg-red-200', 'hover:bg-blue-200', 'hover:bg-green-200', 'hover:bg-yellow-200', 'hover:bg-purple-200', 'hover:bg-pink-200', 'hover:bg-indigo-200', 'hover:bg-teal-200', 'hover:bg-orange-200', 'hover:bg-cyan-200', 'hover:bg-lime-200', 'hover:bg-amber-200'] %}
                {% for course in courses %}
                    {% set color_index = loop.index0 % bg_colors|length %}
                    <div class="rounded-md shadow-sm border border-gray-200 {{ bg_colors[color_index] }} {{ hover_colors[color_index] }} transition duration-300 cursor-pointer relative" onclick="window.location.href='{{ url_for('main.view_course', course_id=course.id) }}'">
                        <!-- Three dots dropdown -->
                        <div class="absolute top-2 right-2 z-10">
                            <button type="button" class="{{ text_colors[color_index] }} hover:bg-white hover:bg-opacity-30 p-2 rounded-full transition duration-300" onclick="event.stopPropagation(); toggleCourseDropdown('course-dropdown-{{ course.id }}')">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div id="course-dropdown-{{ course.id }}" class="absolute right-0 top-full mt-1 w-48 bg-white rounded-md shadow-lg z-50 hidden border border-gray-200">
                                <div class="py-1">
                                    <form action="{{ url_for('main.delete_course', course_id=course.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this course and all its categories/assignments?');" class="block">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center" onclick="event.stopPropagation();">
                                            <i class="fas fa-trash mr-2 text-red-500"></i>
                                            Delete Course
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 pr-12">
                            <!-- Course info content -->
                            <div class="relative">
                                <h4 class="text-base sm:text-lg font-medium {{ text_colors[color_index] }} mb-2">
                                    {{ course.name }}
                                </h4>
                                <p class="text-sm {{ text_colors[color_index] }} opacity-75 mb-2">{{ course.credits }} credits</p>
                                {% if course.is_category %}
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <span class="text-xs sm:text-sm bg-white bg-opacity-80 {{ text_colors[color_index] }} px-2 py-1 rounded">Category</span>
                                </div>
                                {% endif %}
                                
                                <!-- Current Grade and Key Stats on Same Line -->
                                <div class="flex justify-between items-center flex-wrap gap-2">
                                    <p class="text-sm {{ text_colors[color_index] }} opacity-75">
                                        Current Grade: {%- set safe_course_grade = course.overall_grade_percentage if course.overall_grade_percentage is not none and course.overall_grade_percentage != 'undefined' else none -%}
                                        {%- if safe_course_grade is not none -%}
                                            {{ "%.2f"|format(safe_course_grade|float(0)) }}%
                                        {%- else -%}
                                            N/A
                                        {%- endif -%}
                                    </p>
                                    
                                    {% if course.missing_count > 0 or course.due_this_week_count > 0 or course.awaiting_grade_count > 0 %}
                                    <div class="flex gap-2 items-center text-xs {{ text_colors[color_index] }}">
                                        {% if course.missing_count > 0 %}
                                        <span class="inline-flex items-center gap-1">
                                            <span class="opacity-75">Missing:</span>
                                            <span class="bg-red-500 text-white font-semibold px-2 py-0.5 rounded-full">{{ course.missing_count }}</span>
                                        </span>
                                        {% endif %}
                                        {% if course.due_this_week_count > 0 %}
                                        <span class="inline-flex items-center gap-1">
                                            <span class="opacity-75">Due:</span>
                                            <span class="bg-blue-500 text-white font-semibold px-2 py-0.5 rounded-full">{{ course.due_this_week_count }}</span>
                                        </span>
                                        {% endif %}
                                        {% if course.awaiting_grade_count > 0 %}
                                        <span class="inline-flex items-center gap-1">
                                            <span class="opacity-75">Awaiting:</span>
                                            <span class="bg-yellow-500 text-white font-semibold px-2 py-0.5 rounded-full">{{ course.awaiting_grade_count }}</span>
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-600">No courses added to this term yet. Add your first course below!</p>
        {% endif %}
    </div>


<script>
let canvasProgressInterval = null;

// Canvas Sync Functions
function startCanvasSync(syncType, targetId = null) {
    showCanvasProgressSection();
    resetCanvasProgress('Starting Canvas sync...');
    
    fetch('{{ url_for("routes.start_canvas_sync") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            sync_type: syncType,
            target_id: targetId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            startCanvasProgressPolling();
        } else {
            alert('Failed to start Canvas sync: ' + data.message);
            hideCanvasProgressSection();
        }
    })
    .catch(error => {
        alert('Error starting Canvas sync: ' + error);
        hideCanvasProgressSection();
    });
}

function showCanvasProgressSection() {
    document.getElementById('canvas-progress-section').style.display = 'block';
}

function hideCanvasProgressSection() {
    document.getElementById('canvas-progress-section').style.display = 'none';
}

function resetCanvasProgress(operation) {
    updateCanvasProgressUI({
        progress_percent: 0,
        completed_items: 0,
        total_items: 0,
        elapsed_time: 0,
        current_operation: operation,
        current_item: '',
        errors: [],
        is_complete: false
    });
}

function startCanvasProgressPolling() {
    if (canvasProgressInterval) {
        clearInterval(canvasProgressInterval);
    }
    canvasProgressInterval = setInterval(checkCanvasProgress, 500);
}

function checkCanvasProgress() {
    fetch('{{ url_for("routes.get_canvas_sync_progress") }}')
    .then(response => response.json())
    .then(data => {
        updateCanvasProgressUI(data);
        
        if (data.is_complete) {
            clearInterval(canvasProgressInterval);
            canvasProgressInterval = null;
            
            // Show completion message
            setTimeout(() => {
                if (data.errors.length > 0) {
                    alert('Canvas sync completed with some errors. Page will refresh.');
                } else {
                    alert('Canvas sync completed successfully! Page will refresh.');
                }
                location.reload();
            }, 1000);
        }
    })
    .catch(error => {
        console.error('Error checking Canvas sync progress:', error);
    });
}

function updateCanvasProgressUI(data) {
    // Update progress bar
    const progressBar = document.getElementById('canvas-progress-bar');
    const progressText = document.getElementById('canvas-progress-text');
    
    progressBar.style.width = data.progress_percent + '%';
    progressText.textContent = data.progress_percent + '%';
    
    // Update progress color based on completion and errors
    progressBar.className = 'bg-blue-600 h-6 rounded-full transition-all duration-300 flex items-center justify-center';
    if (data.is_complete) {
        progressBar.className = 'bg-green-600 h-6 rounded-full transition-all duration-300 flex items-center justify-center';
    } else if (data.errors.length > 0) {
        progressBar.className = 'bg-yellow-600 h-6 rounded-full transition-all duration-300 flex items-center justify-center';
    }
    
    // Update elapsed time
    document.getElementById('canvas-elapsed-time').textContent = data.elapsed_time + 's';
    
    // Update items count
    document.getElementById('canvas-progress-items').textContent = 
        data.completed_items + ' / ' + data.total_items;
    
    // Update current operation
    let operationText = data.current_operation;
    if (data.current_item) {
        operationText += ' - ' + data.current_item;
    }
    document.getElementById('canvas-current-operation').textContent = operationText;
    
    // Update errors
    const errorSection = document.getElementById('canvas-error-section');
    const errorList = document.getElementById('canvas-error-list');
    
    if (data.errors.length > 0) {
        errorSection.style.display = 'block';
        errorList.innerHTML = '';
        data.errors.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            errorList.appendChild(li);
        });
    } else {
        errorSection.style.display = 'none';
    }
}

// CSRF Token helper
function getCsrfToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}

// Clean up interval on page unload
window.addEventListener('beforeunload', function() {
    if (canvasProgressInterval) {
        clearInterval(canvasProgressInterval);
    }
});

    document.addEventListener('DOMContentLoaded', function() {
        const isWeightedCheckbox = document.getElementById('is_weighted');
        const isCategoryCheckbox = document.getElementById('is_category');
        const gradeCategoriesSection = document.getElementById('grade_categories_section');
        const categoriesSectionTitle = document.getElementById('categories_section_title');
        const addCategoryFieldButton = document.getElementById('add_category_field');
        const categoriesContainer = document.getElementById('categories_container');
        let categoryCount = 0;

        function toggleCategorySection() {
            if (isWeightedCheckbox.checked || isCategoryCheckbox.checked) {
                gradeCategoriesSection.style.display = 'block';
                
                // Update the section title based on which checkbox is checked
                if (isWeightedCheckbox.checked) {
                    categoriesSectionTitle.textContent = 'Grade Categories for this Course';
                } else if (isCategoryCheckbox.checked) {
                    categoriesSectionTitle.textContent = 'Categories for this Course';
                }
                
                if (categoryCount === 0) { // Add one field if none exist
                    addCategoryField();
                }
            } else {
                gradeCategoriesSection.style.display = 'none';
                // Clear existing fields when unchecking
                categoriesContainer.innerHTML = '';
                categoryCount = 0;
            }
        }

        // Implement mutual exclusivity between is_weighted and is_category
        function handleCheckboxExclusivity() {
            isWeightedCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    isCategoryCheckbox.checked = false;
                }
                toggleCategorySection();
            });

            isCategoryCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    isWeightedCheckbox.checked = false;
                }
                toggleCategorySection();
            });
        }

        function addCategoryField() {
            const newCategoryDiv = document.createElement('div');
            newCategoryDiv.classList.add('flex', 'space-x-2', 'items-end');
            
            // Check if we need weight fields or just category names
            if (isWeightedCheckbox.checked) {
                newCategoryDiv.innerHTML = `
                    <div class="flex-grow">
                        <label for="category_name_${categoryCount}" class="block text-sm font-medium text-gray-700">Category Name:</label>
                        <input type="text" id="category_name_${categoryCount}" name="category_names[]" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="flex-grow">
                        <label for="category_weight_${categoryCount}" class="block text-sm font-medium text-gray-700">Weight (%):</label>
                        <input type="number" step="0.1" id="category_weight_${categoryCount}" name="category_weights[]" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               placeholder="e.g., 20 for 20%">
                    </div>
                    <button type="button" class="remove-category-field bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md shadow-sm">Remove</button>
                `;
            } else if (isCategoryCheckbox.checked) {
                newCategoryDiv.innerHTML = `
                    <div class="flex-grow">
                        <label for="category_name_${categoryCount}" class="block text-sm font-medium text-gray-700">Category Name:</label>
                        <input type="text" id="category_name_${categoryCount}" name="category_names[]" required
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <button type="button" class="remove-category-field bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md shadow-sm">Remove</button>
                `;
            }
            
            categoriesContainer.appendChild(newCategoryDiv);

            newCategoryDiv.querySelector('.remove-category-field').addEventListener('click', function() {
                newCategoryDiv.remove();
                categoryCount--; // Decrement count when a field is removed
            });
            categoryCount++;
        }

        handleCheckboxExclusivity();
        addCategoryFieldButton.addEventListener('click', addCategoryField);

        // Initial check on page load
        toggleCategorySection();
    });

    // Course card dropdown functionality
    function toggleCourseDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        const allDropdowns = document.querySelectorAll('[id^="course-dropdown-"]');
        
        // Close all other dropdowns
        allDropdowns.forEach(d => {
            if (d.id !== dropdownId) {
                d.classList.add('hidden');
            }
        });
        
        // Toggle the clicked dropdown
        dropdown.classList.toggle('hidden');
    }

    // Close course dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        const dropdowns = document.querySelectorAll('[id^="course-dropdown-"]');
        const isDropdownButton = event.target.closest('button[onclick*="toggleCourseDropdown"]');
        
        if (!isDropdownButton) {
            dropdowns.forEach(dropdown => {
                dropdown.classList.add('hidden');
            });
        }
    });
    
    // Term Actions Menu Toggle
    document.getElementById('termActionsMenuBtn')?.addEventListener('click', function(e) {
        e.stopPropagation();
        const popover = document.getElementById('termActionsMenuPopover');
        popover.classList.toggle('hidden');
    });
    
    // Export functionality for terms
    window.exportTermData = async function(format, termId) {
        try {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Exporting...';
            button.disabled = true;
            
            const response = await fetch('/api/analytics/export-term', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify({
                    format: format,
                    term_id: termId,
                    email_delivery: true
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification(`${format.toUpperCase()} export started! You will receive an email when ready.`, 'success');
            } else {
                showNotification(`Export failed: ${data.error}`, 'error');
            }
        } catch (error) {
            showNotification(`Export failed: ${error.message}`, 'error');
        } finally {
            setTimeout(() => {
                const button = event.target;
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }
    };
    
    window.generateTermPredictions = async function(termId) {
        try {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Predicting...';
            button.disabled = true;
            
            const response = await fetch(`/api/analytics/predictions?term_id=${termId}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                window.open(`/analytics#predictions?term_id=${termId}`, '_blank');
            } else {
                showNotification(`Prediction failed: ${data.error}`, 'error');
            }
        } catch (error) {
            showNotification(`Prediction failed: ${error.message}`, 'error');
        } finally {
            setTimeout(() => {
                const button = event.target;
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }
    };
    
    window.sendTermReminders = async function(termId) {
        if (!confirm('Send reminder notifications for all overdue assignments in this term?')) {
            return;
        }
        
        try {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Sending...';
            button.disabled = true;
            
            const response = await fetch('/api/notifications/send-reminders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify({ term_id: termId })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification(`Reminders sent successfully!`, 'success');
            } else {
                showNotification(`Failed to send reminders: ${data.error}`, 'error');
            }
        } catch (error) {
            showNotification(`Failed to send reminders: ${error.message}`, 'error');
        } finally {
            setTimeout(() => {
                const button = event.target;
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }
    };
    
    window.exportAllGrades = async function(termId) {
        try {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Exporting...';
            button.disabled = true;
            
            const response = await fetch('/api/analytics/export-all-grades', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify({
                    term_id: termId,
                    format: 'excel',
                    email_delivery: true
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification('Grade export started! You will receive an email when ready.', 'success');
            } else {
                showNotification(`Export failed: ${data.error}`, 'error');
            }
        } catch (error) {
            showNotification(`Export failed: ${error.message}`, 'error');
        } finally {
            setTimeout(() => {
                const button = event.target;
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }
    };
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
            type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
            type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
            'bg-blue-100 text-blue-800 border border-blue-200'
        }`;
        
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' :
                    type === 'error' ? 'fa-exclamation-circle' :
                    'fa-info-circle'
                } mr-2"></i>
                <span class="text-sm">${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
</script>
    </div>

    <div class="mt-8 pt-6 border-t border-gray-200 text-center">
        <a href="{{ url_for('main.dashboard') }}" class="inline-block bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md font-semibold transition duration-300 shadow-md">
            Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
