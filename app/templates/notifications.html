{% extends "base.html" %}

{% block title %}Notifications{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Notifications Center</h1>
                <p class="text-gray-600 mt-1">Manage your academic alerts and updates</p>
            </div>
            <div class="flex space-x-3">
                <button id="mark-all-read" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    <i class="fas fa-check-double mr-2"></i>Mark All Read
                </button>
                <button id="clear-all-notifications" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                    <i class="fas fa-trash-alt mr-2"></i>Clear All
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-full">
                    <i class="fas fa-bell text-blue-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Total Notifications</h3>
                    <p class="text-2xl font-bold text-gray-900" id="total-count">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-red-100 rounded-full">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Unread</h3>
                    <p class="text-2xl font-bold text-gray-900" id="unread-count">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-yellow-100 rounded-full">
                    <i class="fas fa-chart-line text-yellow-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Predictions</h3>
                    <p class="text-2xl font-bold text-gray-900" id="predictions-count">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-full">
                    <i class="fas fa-trophy text-green-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">Achievements</h3>
                    <p class="text-2xl font-bold text-gray-900" id="achievements-count">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button class="notification-filter active border-b-2 border-blue-500 py-2 px-1 text-sm font-medium text-blue-600" data-filter="all">
                    All Notifications
                </button>
                <button class="notification-filter border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-filter="unread">
                    Unread
                </button>
                <button class="notification-filter border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-filter="predictions">
                    Predictions
                </button>
                <button class="notification-filter border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-filter="achievements">
                    Achievements
                </button>
                <button class="notification-filter border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-filter="reminders">
                    Reminders
                </button>
            </nav>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <!-- Loading State -->
        <div id="notifications-loading" class="p-8 text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-500">Loading notifications...</p>
        </div>

        <!-- Empty State -->
        <div id="notifications-empty" class="hidden p-8 text-center">
            <div class="text-gray-300 text-4xl mb-4">
                <i class="fas fa-bell-slash"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No notifications yet</h3>
            <p class="text-gray-500">You're all caught up! New notifications will appear here.</p>
        </div>

        <!-- Notifications Container -->
        <div id="notifications-container" class="hidden">
            <div class="divide-y divide-gray-200" id="notifications-list">
                <!-- Notifications will be loaded here -->
            </div>
            
            <!-- Load More Button -->
            <div class="p-4 text-center border-t border-gray-200">
                <button id="load-more" class="text-blue-600 hover:text-blue-800 font-medium">
                    Load More Notifications
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Actions Modal -->
<div id="notification-modal" class="fixed inset-0 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-black opacity-30"></div>
        <div class="relative bg-white rounded-lg max-w-md w-full p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Notification Actions</h3>
            <div id="modal-content">
                <!-- Modal content will be populated here -->
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button id="modal-confirm" class="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Notifications page JavaScript
document.addEventListener('DOMContentLoaded', function() {
    let currentFilter = 'all';
    let currentPage = 1;
    let loading = false;

    // Initialize page
    loadNotifications();
    updateStats();

    // Filter event listeners
    document.querySelectorAll('.notification-filter').forEach(button => {
        button.addEventListener('click', function() {
            // Update active filter
            document.querySelectorAll('.notification-filter').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            this.classList.remove('border-transparent', 'text-gray-500');
            this.classList.add('active', 'border-blue-500', 'text-blue-600');
            
            currentFilter = this.dataset.filter;
            currentPage = 1;
            loadNotifications(true);
        });
    });

    // Action buttons
    document.getElementById('mark-all-read').addEventListener('click', markAllRead);
    document.getElementById('clear-all-notifications').addEventListener('click', clearAllNotifications);
    document.getElementById('load-more').addEventListener('click', loadMoreNotifications);

    // Modal handlers
    document.getElementById('modal-cancel').addEventListener('click', hideModal);

    function loadNotifications(reset = false) {
        if (loading) return;
        loading = true;

        if (reset) {
            document.getElementById('notifications-list').innerHTML = '';
            document.getElementById('notifications-container').classList.add('hidden');
            document.getElementById('notifications-loading').classList.remove('hidden');
            document.getElementById('notifications-empty').classList.add('hidden');
        }

        fetch(`/api/analytics/notifications?filter=${currentFilter}&page=${currentPage}`)
            .then(response => {
                // Check if response is valid JSON
                const contentType = response.headers.get('content-type');
                if (!response.ok || !contentType || !contentType.includes('application/json')) {
                    throw new Error('Invalid response format or authentication required');
                }
                return response.json();
            })
            .then(data => {
                loading = false;
                document.getElementById('notifications-loading').classList.add('hidden');
                
                if (data.notifications && data.notifications.length > 0) {
                    renderNotifications(data.notifications, reset);
                    document.getElementById('notifications-container').classList.remove('hidden');
                    
                    // Show/hide load more button
                    const loadMoreBtn = document.getElementById('load-more');
                    if (data.has_more) {
                        loadMoreBtn.style.display = 'block';
                    } else {
                        loadMoreBtn.style.display = 'none';
                    }
                } else if (reset) {
                    document.getElementById('notifications-empty').classList.remove('hidden');
                }
            })
            .catch(error => {
                loading = false;
                console.error('Error loading notifications:', error);
                document.getElementById('notifications-loading').classList.add('hidden');
                if (reset) {
                    document.getElementById('notifications-empty').classList.remove('hidden');
                }
            });
    }

    function renderNotifications(notifications, reset) {
        const container = document.getElementById('notifications-list');
        if (reset) container.innerHTML = '';

        notifications.forEach(notification => {
            const notificationEl = createNotificationElement(notification);
            container.appendChild(notificationEl);
        });
    }

    function createNotificationElement(notification) {
        const div = document.createElement('div');
        div.className = `p-4 hover:bg-gray-50 cursor-pointer ${!notification.is_read ? 'bg-blue-50 border-l-4 border-blue-500' : ''}`;
        div.dataset.notificationId = notification.id;

        const iconClass = getNotificationIcon(notification.type);
        const iconColor = getNotificationColor(notification.type);

        div.innerHTML = `
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 ${iconColor} rounded-full flex items-center justify-center">
                        <i class="${iconClass} text-white text-sm"></i>
                    </div>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-sm font-medium text-gray-900">${notification.title}</p>
                    <p class="text-sm text-gray-600 mt-1">${notification.message}</p>
                    <p class="text-xs text-gray-400 mt-2">${formatDate(notification.created_at)}</p>
                </div>
                <div class="ml-2 flex-shrink-0">
                    <button class="text-gray-400 hover:text-gray-600" onclick="markAsRead(${notification.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;

        div.addEventListener('click', () => handleNotificationClick(notification));
        return div;
    }

    function getNotificationIcon(type) {
        const icons = {
            'prediction': 'fas fa-chart-line',
            'achievement': 'fas fa-trophy',
            'reminder': 'fas fa-clock',
            'warning': 'fas fa-exclamation-triangle',
            'info': 'fas fa-info-circle'
        };
        return icons[type] || 'fas fa-bell';
    }

    function getNotificationColor(type) {
        const colors = {
            'prediction': 'bg-blue-600',
            'achievement': 'bg-green-600',
            'reminder': 'bg-yellow-600',
            'warning': 'bg-red-600',
            'info': 'bg-gray-600'
        };
        return colors[type] || 'bg-blue-600';
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        return date.toLocaleDateString();
    }

    function updateStats() {
        fetch('/api/analytics/notifications/analytics')
            .then(response => {
                const contentType = response.headers.get('content-type');
                if (!response.ok || !contentType || !contentType.includes('application/json')) {
                    throw new Error('Invalid response format or authentication required');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('total-count').textContent = data.total || 0;
                document.getElementById('unread-count').textContent = data.unread || 0;
                document.getElementById('predictions-count').textContent = data.predictions || 0;
                document.getElementById('achievements-count').textContent = data.achievements || 0;
            })
            .catch(error => console.error('Error updating stats:', error));
    }

    function markAllRead() {
        fetch('/api/analytics/notifications/mark-all-read', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadNotifications(true);
                    updateStats();
                }
            })
            .catch(error => console.error('Error marking all read:', error));
    }

    function clearAllNotifications() {
        if (confirm('Are you sure you want to clear all notifications? This action cannot be undone.')) {
            fetch('/api/analytics/notifications/clear-all', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadNotifications(true);
                        updateStats();
                    }
                })
                .catch(error => console.error('Error clearing notifications:', error));
        }
    }

    function loadMoreNotifications() {
        currentPage++;
        loadNotifications(false);
    }

    function markAsRead(notificationId) {
        fetch(`/api/analytics/notifications/${notificationId}/read`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const notificationEl = document.querySelector(`[data-notification-id="${notificationId}"]`);
                    if (notificationEl) {
                        notificationEl.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                    }
                    updateStats();
                }
            })
            .catch(error => console.error('Error marking as read:', error));
    }

    function handleNotificationClick(notification) {
        // Handle notification click (e.g., navigate to related content)
        if (notification.action_url) {
            window.location.href = notification.action_url;
        }
    }

    function hideModal() {
        document.getElementById('notification-modal').classList.add('hidden');
    }

    // Make functions globally available
    window.markAsRead = markAsRead;
});
</script>
{% endblock %}