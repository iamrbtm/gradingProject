<!-- Notification Center Widget -->
<div id="notification-center" class="relative">
    <!-- Notification Bell Icon -->
    <button id="notification-bell" class="relative p-2 text-gray-400 hover:text-gray-600 focus:outline-none focus:text-gray-600 transition duration-300" onclick="toggleNotificationCenter()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
        </svg>
        
        <!-- Unread Count Badge -->
        <span id="notification-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
    </button>
    
    <!-- Notification Dropdown Panel -->
    <div id="notification-panel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50 max-h-96 overflow-hidden">
        <!-- Panel Header -->
        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 rounded-t-lg">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-900">Notifications</h3>
                <div class="flex space-x-2">
                    <button id="mark-all-read-btn" class="text-xs text-blue-600 hover:text-blue-800 font-medium">Mark all read</button>
                    <button id="clear-all-btn" class="text-xs text-gray-500 hover:text-gray-700">Clear all</button>
                </div>
            </div>
        </div>
        
        <!-- Notification List -->
        <div id="notification-list" class="max-h-80 overflow-y-auto">
            <!-- Loading State -->
            <div id="notifications-loading" class="px-4 py-6 text-center">
                <i class="fas fa-spinner fa-spin text-gray-400 mb-2"></i>
                <p class="text-sm text-gray-500">Loading notifications...</p>
            </div>
            
            <!-- Empty State -->
            <div id="notifications-empty" class="hidden px-4 py-6 text-center">
                <i class="fas fa-bell-slash text-gray-300 text-2xl mb-2"></i>
                <p class="text-sm text-gray-500">No notifications</p>
            </div>
            
            <!-- Notification Items Container -->
            <div id="notification-items">
                <!-- Notifications will be populated here -->
            </div>
        </div>
        
        <!-- Panel Footer -->
        <div class="px-4 py-3 border-t border-gray-200 bg-gray-50 rounded-b-lg">
            <a href="{{ url_for('main.notifications') }}" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center">
                <i class="fas fa-external-link-alt mr-1"></i>
                View all notifications
            </a>
        </div>
    </div>
</div>

<!-- Notification Center JavaScript -->
<script>
let notificationPanel = null;
let notificationCount = 0;
let notifications = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeNotificationCenter();
});

function initializeNotificationCenter() {
    notificationPanel = document.getElementById('notification-panel');
    
    // Load initial notifications
    loadNotifications();
    
    // Set up event listeners
    setupNotificationEventListeners();
    
    // Set up periodic refresh (every 30 seconds)
    setInterval(loadNotifications, 30000);
    
    // Close panel when clicking outside
    document.addEventListener('click', function(event) {
        const notificationCenter = document.getElementById('notification-center');
        if (!notificationCenter.contains(event.target)) {
            hideNotificationCenter();
        }
    });
}

function setupNotificationEventListeners() {
    // Mark all read button
    document.getElementById('mark-all-read-btn')?.addEventListener('click', function() {
        markAllNotificationsRead();
    });
    
    // Clear all button
    document.getElementById('clear-all-btn')?.addEventListener('click', function() {
        clearAllNotifications();
    });
}

function toggleNotificationCenter() {
    if (notificationPanel.classList.contains('hidden')) {
        showNotificationCenter();
    } else {
        hideNotificationCenter();
    }
}

function showNotificationCenter() {
    notificationPanel.classList.remove('hidden');
    // Refresh notifications when opening
    loadNotifications();
}

function hideNotificationCenter() {
    notificationPanel.classList.add('hidden');
}

async function loadNotifications() {
    try {
        const response = await fetch('/api/analytics/notifications');
        
        // Check if response is HTML (redirect to login)
        const contentType = response.headers.get('content-type');
        if (!response.ok || !contentType || !contentType.includes('application/json')) {
            console.log('Not authenticated for notifications, skipping...');
            return;
        }
        
        const data = await response.json();
        
        // Normalize response formats (support both old {status:'success', notifications:[]} and new direct responses)
        let notificationsList = [];
        if (data && data.status === 'success' && Array.isArray(data.notifications)) {
            notificationsList = data.notifications;
        } else if (Array.isArray(data.notifications)) {
            notificationsList = data.notifications;
        } else if (Array.isArray(data.data && data.data.notifications)) {
            notificationsList = data.data.notifications;
        } else if (Array.isArray(data)) {
            // Some endpoints may return the array directly
            notificationsList = data;
        }
        
        if (notificationsList.length !== 0 || (data && (Array.isArray(data.notifications) || Array.isArray(data.data && data.data.notifications)))) {
            notifications = notificationsList || [];
            updateNotificationUI();
        } else {
            console.error('Failed to load notifications:', (data && data.error) ? data.error : data);
            showNotificationError();
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
        showNotificationError();
    }
}

function updateNotificationUI() {
    updateNotificationCount();
    updateNotificationList();
}

function updateNotificationCount() {
    const unreadCount = notifications.filter(n => !n.is_read).length;
    const countBadge = document.getElementById('notification-count');
    
    if (unreadCount > 0) {
        countBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        countBadge.classList.remove('hidden');
    } else {
        countBadge.classList.add('hidden');
    }
    
    notificationCount = unreadCount;
}

function updateNotificationList() {
    const loadingEl = document.getElementById('notifications-loading');
    const emptyEl = document.getElementById('notifications-empty');
    const itemsContainer = document.getElementById('notification-items');
    
    // Hide loading state
    loadingEl.classList.add('hidden');
    
    if (notifications.length === 0) {
        emptyEl.classList.remove('hidden');
        itemsContainer.innerHTML = '';
        return;
    }
    
    emptyEl.classList.add('hidden');
    
    // Sort notifications by date (newest first)
    const sortedNotifications = [...notifications].sort((a, b) => 
        new Date(b.created_at) - new Date(a.created_at)
    );
    
    itemsContainer.innerHTML = sortedNotifications.map(notification => 
        createNotificationHTML(notification)
    ).join('');
}

function createNotificationHTML(notification) {
    const isUnread = !notification.is_read;
    const icon = getNotificationIcon(notification.type);
    const timeAgo = formatTimeAgo(notification.created_at);
    
    return `
        <div class="notification-item px-4 py-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer ${isUnread ? 'bg-blue-50' : ''}" 
             data-id="${notification.id}" 
             onclick="handleNotificationClick('${notification.id}')">
            <div class="flex items-start space-x-3">
                <!-- Notification Icon -->
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center ${getIconBgColor(notification.type)}">
                        <i class="fas ${icon} text-sm ${getIconTextColor(notification.type)}"></i>
                    </div>
                </div>
                
                <!-- Notification Content -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-900 ${isUnread ? 'font-semibold' : ''}">${notification.title}</p>
                        ${isUnread ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                    </div>
                    <p class="text-sm text-gray-600 mt-1">${notification.message}</p>
                    <p class="text-xs text-gray-400 mt-1">${timeAgo}</p>
                </div>
            </div>
        </div>
    `;
}

function getNotificationIcon(type) {
    const icons = {
        'grade_update': 'fa-edit',
        'prediction': 'fa-crystal-ball',
        'risk_alert': 'fa-exclamation-triangle',
        'achievement': 'fa-trophy',
        'reminder': 'fa-clock',
        'system': 'fa-cog',
        'export': 'fa-download',
        'sync': 'fa-sync'
    };
    return icons[type] || 'fa-bell';
}

function getIconBgColor(type) {
    const colors = {
        'grade_update': 'bg-blue-100',
        'prediction': 'bg-purple-100',
        'risk_alert': 'bg-red-100',
        'achievement': 'bg-yellow-100',
        'reminder': 'bg-green-100',
        'system': 'bg-gray-100',
        'export': 'bg-indigo-100',
        'sync': 'bg-teal-100'
    };
    return colors[type] || 'bg-gray-100';
}

function getIconTextColor(type) {
    const colors = {
        'grade_update': 'text-blue-600',
        'prediction': 'text-purple-600',
        'risk_alert': 'text-red-600',
        'achievement': 'text-yellow-600',
        'reminder': 'text-green-600',
        'system': 'text-gray-600',
        'export': 'text-indigo-600',
        'sync': 'text-teal-600'
    };
    return colors[type] || 'text-gray-600';
}

function formatTimeAgo(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
    if (diffMins < 10080) return `${Math.floor(diffMins / 1440)}d ago`;
    return date.toLocaleDateString();
}

async function handleNotificationClick(notificationId) {
    try {
        // Mark notification as read
        await markNotificationRead(notificationId);
        
        // Find the notification
        const notification = notifications.find(n => n.id === notificationId);
        if (notification && notification.action_url) {
            // Navigate to action URL if available
            window.location.href = notification.action_url;
        }
    } catch (error) {
        console.error('Error handling notification click:', error);
    }
}

async function markNotificationRead(notificationId) {
    try {
        const response = await fetch(`/api/analytics/notifications/${notificationId}/read`, {
            method: 'POST'
        });
        
        if (response.ok) {
            // Update local notification state
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.is_read = true;
            }
            updateNotificationUI();
        }
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

async function markAllNotificationsRead() {
    try {
        const response = await fetch('/api/analytics/notifications/mark-all-read', {
            method: 'POST'
        });
        
        if (response.ok) {
            // Update all local notifications
            notifications.forEach(n => n.is_read = true);
            updateNotificationUI();
            showToast('All notifications marked as read', 'success');
        }
    } catch (error) {
        console.error('Error marking all notifications as read:', error);
        showToast('Failed to mark notifications as read', 'error');
    }
}

async function clearAllNotifications() {
    if (!confirm('Are you sure you want to clear all notifications? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/analytics/notifications/clear-all', {
            method: 'POST'
        });
        
        if (response.ok) {
            notifications = [];
            updateNotificationUI();
            showToast('All notifications cleared', 'success');
        }
    } catch (error) {
        console.error('Error clearing notifications:', error);
        showToast('Failed to clear notifications', 'error');
    }
}

function showNotificationError() {
    const loadingEl = document.getElementById('notifications-loading');
    const itemsContainer = document.getElementById('notification-items');
    
    loadingEl.classList.add('hidden');
    itemsContainer.innerHTML = `
        <div class="px-4 py-6 text-center">
            <i class="fas fa-exclamation-triangle text-red-400 text-xl mb-2"></i>
            <p class="text-sm text-red-600">Failed to load notifications</p>
            <button onclick="loadNotifications()" class="text-xs text-blue-600 hover:text-blue-800 mt-2">Try again</button>
        </div>
    `;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 p-3 rounded-lg shadow-lg text-sm ${
        type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
        type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
        'bg-blue-100 text-blue-800 border border-blue-200'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Export function for other scripts to use
window.refreshNotifications = loadNotifications;
</script>