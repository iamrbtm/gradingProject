{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block head %}
    {{ super() }}
    <meta name="user-id" content="{{ current_user.id }}">
    <meta name="current-user-id" content="{{ current_user.id }}">
    <meta name="enhanced-canvas-endpoints" content='{
        "start": "{{ url_for("canvas_sync_enhanced.start_enhanced_canvas_sync") }}",
        "progress_stream": "{{ url_for("canvas_sync_enhanced.canvas_progress_stream") }}",
        "progress": "{{ url_for("canvas_sync_enhanced.canvas_progress_enhanced") }}",
        "cancel": "{{ url_for("canvas_sync_enhanced.cancel_canvas_sync") }}",
        "retry": "{{ url_for("canvas_sync_enhanced.retry_canvas_sync") }}",
        "status": "{{ url_for("canvas_sync_enhanced.canvas_sync_status") }}",
        "test_connection": "{{ url_for("canvas_sync_enhanced.test_canvas_connection") }}",
        "preview": "{{ url_for("canvas_sync_enhanced.canvas_sync_preview") }}"
    }'>
{% endblock %}

{% block content %}
<div class="bg-white p-4 sm:p-6 rounded-lg shadow-xl border border-gray-200">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4 sm:mb-6">Your Academic Dashboard</h1>

    <!-- Canvas Integration Section -->
    <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div class="mb-3 sm:mb-0">
                <h2 class="text-lg font-semibold text-blue-800">Canvas Integration</h2>
                <p class="text-sm text-blue-600">Sync your Canvas courses, assignments, and grades</p>
                <p class="text-xs text-blue-500 mt-1">ðŸ’¡ Sync levels: Dashboard (all), Term pages, Course pages</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2">
                {% if current_user.canvas_base_url and current_user.canvas_access_token %}
                    <button type="button" onclick="enhancedCanvasSync.startSync('all')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-300 flex items-center">
                        <i class="fas fa-sync mr-2"></i>Sync All from Canvas (Enhanced)
                    </button>
                    <button type="button" onclick="enhancedCanvasSync.toggleAdvancedOptions()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-300 flex items-center">
                        <i class="fas fa-cog mr-2"></i>Advanced Options
                    </button>
                {% endif %}
                <a href="{{ url_for('routes.settings') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-300 text-center">
                    {% if current_user.canvas_base_url and current_user.canvas_access_token %}
                        Canvas Settings
                    {% else %}
                        Setup Canvas
                    {% endif %}
                </a>
            </div>
        </div>
        {% if current_user.canvas_last_sync %}
        <div class="mt-2 text-xs text-blue-600">
            Last synced: {{ current_user.canvas_last_sync.strftime('%Y-%m-%d at %H:%M') }}
        </div>
        {% endif %}
    </div>

    <!-- Enhanced Canvas Sync Container -->
    <div id="canvas-sync-container" class="mb-6">
        <!-- This will be populated by the enhanced Canvas sync JavaScript -->
    </div>

    <!-- Notifications Section -->
    {% if notifications %}
    <div class="mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-3">Notifications</h2>
        <div class="space-y-2">
            {% for notification in notifications %}
            <div class="p-3 rounded-md {% if notification.type == 'overdue' %}bg-red-50 border border-red-200{% else %}bg-yellow-50 border border-yellow-200{% endif %}">
                <p class="text-sm {% if notification.type == 'overdue' %}text-red-800{% else %}text-yellow-800{% endif %}">
                    {{ notification.message }}
                </p>
            </div>
            {% endfor %}
        </div>
        <div class="mt-3">
            <a href="{{ url_for('routes.send_reminders') }}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                Send Email Reminders
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Analytics Dashboard Widgets -->
    {% include 'analytics_widgets.html' %}

    <div class="mb-6 sm:mb-8">
        <h2 class="text-xl sm:text-2xl font-semibold text-gray-700 mb-3 sm:mb-4">Your Terms</h2>
        {% if active_terms %}
            <h3 class="text-lg font-medium text-gray-600 mb-3">Active Terms</h3>
             <ul class="space-y-4 mb-6">
                 {% for term in active_terms %}
                     <li class="bg-gray-50 rounded-md shadow-sm border border-gray-200 hover:bg-gray-100 transition duration-300">
                         <div class="p-4 flex justify-between items-start cursor-pointer" onclick="window.location.href='{{ url_for('main.view_term', term_id=term.id) }}'">
                             <!-- Term info content -->
                             <div class="flex-1">
                                 <h4 class="text-base sm:text-lg font-medium text-gray-800 mb-1">
                                     {{ term.nickname }} ({{ term.season }} {{ term.year }})
                                 </h4>
                                 <p class="text-sm text-gray-600">{{ term.school_name }}</p>
                                 {% if term.start_date and term.end_date %}
                                 <p class="text-sm text-gray-600">{{ term.start_date.strftime('%b %d') }} - {{ term.end_date.strftime('%b %d, %Y') }}</p>
                                 {% endif %}
                             </div>
                             
                             <!-- Three dots dropdown -->
                             <div class="relative ml-4">
                                 <button type="button" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-200 transition duration-300" onclick="event.stopPropagation(); toggleDropdown('dropdown-{{ term.id }}')">
                                     <i class="fas fa-ellipsis-v"></i>
                                 </button>
                                 <div id="dropdown-{{ term.id }}" class="absolute right-0 top-full mt-1 w-48 bg-white rounded-md shadow-lg z-50 hidden border border-gray-200">
                                     <div class="py-1">
                                         <form action="{{ url_for('main.toggle_term_active', term_id=term.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to deactivate this term? It will become read-only.');" class="block">
                                             <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                             <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center" onclick="event.stopPropagation();">
                                                 <i class="fas fa-pause mr-2 text-yellow-500"></i>
                                                 Deactivate
                                             </button>
                                         </form>
                                         <form action="{{ url_for('main.delete_term', term_id=term.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this term and all its courses/assignments?');" class="block">
                                             <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                             <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center" onclick="event.stopPropagation();">
                                                 <i class="fas fa-trash mr-2 text-red-500"></i>
                                                 Delete
                                             </button>
                                         </form>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </li>
                 {% endfor %}
             </ul>
        {% endif %}
        
        {% if inactive_terms %}
            <h3 class="text-lg font-medium text-gray-600 mb-3">Inactive Terms (Read-Only)</h3>
             <ul class="space-y-4 mb-6">
                 {% for term in inactive_terms %}
                     <li class="bg-gray-100 rounded-md shadow-sm border border-gray-300 opacity-75 hover:opacity-90 transition duration-300">
                         <div class="p-4 flex justify-between items-start cursor-pointer" onclick="window.location.href='{{ url_for('main.view_term', term_id=term.id) }}'">
                             <!-- Term info content -->
                             <div class="flex-1">
                                 <h4 class="text-base sm:text-lg font-medium text-gray-600 mb-1">
                                     {{ term.nickname }} ({{ term.season }} {{ term.year }})
                                     <span class="text-sm text-red-600 font-normal">[INACTIVE]</span>
                                 </h4>
                                 <p class="text-sm text-gray-500">{{ term.school_name }}</p>
                                 {% if term.start_date and term.end_date %}
                                 <p class="text-sm text-gray-500">{{ term.start_date.strftime('%b %d') }} - {{ term.end_date.strftime('%b %d, %Y') }}</p>
                                 {% endif %}
                             </div>
                             
                             <!-- Three dots dropdown -->
                             <div class="relative ml-4">
                                 <button type="button" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-200 transition duration-300" onclick="event.stopPropagation(); toggleDropdown('dropdown-{{ term.id }}')">
                                     <i class="fas fa-ellipsis-v"></i>
                                 </button>
                                 <div id="dropdown-{{ term.id }}" class="absolute right-0 top-full mt-1 w-48 bg-white rounded-md shadow-lg z-50 hidden border border-gray-200">
                                     <div class="py-1">
                                         <form action="{{ url_for('main.toggle_term_active', term_id=term.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to reactivate this term?');" class="block">
                                             <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                             <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center" onclick="event.stopPropagation();">
                                                 <i class="fas fa-play mr-2 text-green-500"></i>
                                                 Reactivate
                                             </button>
                                         </form>
                                         <form action="{{ url_for('main.delete_term', term_id=term.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this term and all its courses/assignments?');" class="block">
                                             <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                             <button type="submit" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center" onclick="event.stopPropagation();">
                                                 <i class="fas fa-trash mr-2 text-red-500"></i>
                                                 Delete
                                             </button>
                                         </form>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </li>
                 {% endfor %}
             </ul>
        {% endif %}
        
        {% if not active_terms and not inactive_terms %}
            <p class="text-gray-600">You haven't added any terms yet. Start by adding your first academic term!</p>
        {% endif %}
    </div>

    <div class="mb-6 sm:mb-8">
        <h2 class="text-xl sm:text-2xl font-semibold text-gray-700 mb-3 sm:mb-4">Add New Term</h2>
        <form action="{{ url_for('main.add_term') }}" method="POST" class="space-y-4 sm:space-y-0 sm:flex sm:items-center sm:space-x-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <!-- Mobile: stacked layout, Desktop: horizontal layout -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-2 flex-1">
                <input type="text" id="nickname" name="nickname" placeholder="Nickname" required
                       class="p-3 sm:p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base min-h-[44px]">
                <select id="season" name="season" required
                        class="p-3 sm:p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base min-h-[44px]">
                    <option value="Fall" {% if current_season == 'Fall' %}selected{% endif %}>Fall</option>
                    <option value="Winter" {% if current_season == 'Winter' %}selected{% endif %}>Winter</option>
                    <option value="Spring" {% if current_season == 'Spring' %}selected{% endif %}>Spring</option>
                    <option value="Summer" {% if current_season == 'Summer' %}selected{% endif %}>Summer</option>
                </select>
                <input type="number" id="year" name="year" required min="1900" max="2100" value="{{ current_year }}"
                       class="p-3 sm:p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base min-h-[44px]">
                <input type="text" id="school_name" name="school_name" placeholder="School Name" required list="schools"
                       class="p-3 sm:p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base min-h-[44px]">
            </div>
            <datalist id="schools">
                {% for school in schools %}
                    <option value="{{ school }}">
                {% endfor %}
            </datalist>
            <button type="submit"
                    class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-5 py-3 sm:py-2 rounded-md font-semibold transition duration-300 ease-in-out shadow-md text-base min-h-[44px]">
                Add Term
            </button>
        </form>
    </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/enhanced_canvas_sync.js') }}"></script>
<script>
let canvasProgressInterval = null;
let enhancedCanvasSync = null;

// Initialize enhanced Canvas sync when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize enhanced Canvas sync if available
    if (typeof EnhancedCanvasSync !== 'undefined') {
        enhancedCanvasSync = new EnhancedCanvasSync();
        console.log('Enhanced Canvas sync initialized successfully');
    } else {
        console.warn('Enhanced Canvas sync not available, falling back to basic sync');
        // Create fallback object
        enhancedCanvasSync = {
            startSync: function(syncType, targetId) {
                startCanvasSync(syncType, targetId);
            },
            toggleAdvancedOptions: function() {
                alert('Enhanced Canvas sync features not available. Please check that all required dependencies are installed.');
            }
        };
    }
});

// Canvas Sync Functions
function startCanvasSync(syncType, targetId = null) {
    showCanvasProgressSection();
    resetCanvasProgress('Starting Canvas sync...');
    
    fetch('{{ url_for("routes.start_canvas_sync") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            sync_type: syncType,
            target_id: targetId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            startCanvasProgressPolling();
        } else {
            alert('Failed to start Canvas sync: ' + data.message);
            hideCanvasProgressSection();
        }
    })
    .catch(error => {
        alert('Error starting Canvas sync: ' + error);
        hideCanvasProgressSection();
    });
}

function showCanvasProgressSection() {
    document.getElementById('canvas-progress-section').style.display = 'block';
}

function hideCanvasProgressSection() {
    document.getElementById('canvas-progress-section').style.display = 'none';
}

function resetCanvasProgress(operation) {
    updateCanvasProgressUI({
        progress_percent: 0,
        completed_items: 0,
        total_items: 0,
        elapsed_time: 0,
        current_operation: operation,
        current_item: '',
        errors: [],
        is_complete: false
    });
}

function startCanvasProgressPolling() {
    if (canvasProgressInterval) {
        clearInterval(canvasProgressInterval);
    }
    canvasProgressInterval = setInterval(checkCanvasProgress, 500);
}

function checkCanvasProgress() {
    fetch('{{ url_for("routes.get_canvas_sync_progress") }}')
    .then(response => response.json())
    .then(data => {
        updateCanvasProgressUI(data);
        
        if (data.is_complete) {
            clearInterval(canvasProgressInterval);
            canvasProgressInterval = null;
            
            // Show completion message
            setTimeout(() => {
                if (data.errors.length > 0) {
                    alert('Canvas sync completed with some errors. Page will refresh.');
                } else {
                    alert('Canvas sync completed successfully! Page will refresh.');
                }
                location.reload();
            }, 1000);
        }
    })
    .catch(error => {
        console.error('Error checking Canvas sync progress:', error);
    });
}

function updateCanvasProgressUI(data) {
    // Update progress bar
    const progressBar = document.getElementById('canvas-progress-bar');
    const progressText = document.getElementById('canvas-progress-text');
    
    progressBar.style.width = data.progress_percent + '%';
    progressText.textContent = data.progress_percent + '%';
    
    // Update progress color based on completion and errors
    progressBar.className = 'bg-blue-600 h-6 rounded-full transition-all duration-300 flex items-center justify-center';
    if (data.is_complete) {
        progressBar.className = 'bg-green-600 h-6 rounded-full transition-all duration-300 flex items-center justify-center';
    } else if (data.errors.length > 0) {
        progressBar.className = 'bg-yellow-600 h-6 rounded-full transition-all duration-300 flex items-center justify-center';
    }
    
    // Update elapsed time
    document.getElementById('canvas-elapsed-time').textContent = data.elapsed_time + 's';
    
    // Update items count
    document.getElementById('canvas-progress-items').textContent = 
        data.completed_items + ' / ' + data.total_items;
    
    // Update current operation
    let operationText = data.current_operation;
    if (data.current_item) {
        operationText += ' - ' + data.current_item;
    }
    document.getElementById('canvas-current-operation').textContent = operationText;
    
    // Update errors
    const errorSection = document.getElementById('canvas-error-section');
    const errorList = document.getElementById('canvas-error-list');
    
    if (data.errors.length > 0) {
        errorSection.style.display = 'block';
        errorList.innerHTML = '';
        data.errors.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            errorList.appendChild(li);
        });
    } else {
        errorSection.style.display = 'none';
    }
}

// CSRF Token helper
function getCsrfToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}

// Clean up interval on page unload
window.addEventListener('beforeunload', function() {
    if (canvasProgressInterval) {
        clearInterval(canvasProgressInterval);
    }
});

function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    const allDropdowns = document.querySelectorAll('[id^="dropdown-"]');
    
    // Close all other dropdowns
    allDropdowns.forEach(d => {
        if (d.id !== dropdownId) {
            d.classList.add('hidden');
        }
    });
    
    // Toggle the clicked dropdown
    dropdown.classList.toggle('hidden');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const dropdowns = document.querySelectorAll('[id^="dropdown-"]');
    const isDropdownButton = event.target.closest('button[onclick*="toggleDropdown"]');
    
    if (!isDropdownButton) {
        dropdowns.forEach(dropdown => {
            dropdown.classList.add('hidden');
        });
    }
});
</script>

{% endblock %}
