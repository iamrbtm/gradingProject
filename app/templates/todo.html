{% extends "base.html" %}

{% block title %}ToDo{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-amber-50 to-orange-50 p-6 rounded-lg shadow-xl border border-amber-200 mb-7">
    <h2 class="text-2xl font-semibold text-amber-800 mb-4">üìù Your Tasks & Assignments</h2>
    <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
        <form action="{{ url_for('main.add_todo_item') }}" method="POST" class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 flex-1">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="text" name="description" placeholder="What needs to be done?" required
                    class="w-full sm:w-auto p-3 border border-amber-200 rounded-lg shadow-sm focus:ring-amber-400 focus:border-amber-400 sm:text-sm bg-white/90 placeholder-amber-600">
            <input type="date" name="due_date"
                    class="w-full sm:w-auto p-3 border border-amber-200 rounded-lg shadow-sm focus:ring-amber-400 focus:border-amber-400 sm:text-sm bg-white/90">
            <select name="course_id" class="w-full sm:w-auto p-3 border border-amber-200 rounded-lg shadow-sm focus:ring-amber-400 focus:border-amber-400 sm:text-sm bg-white/90">
                <option value="">-- Select Course (Optional) --</option>
                {% for course in courses %}
                <option value="{{ course.id }}">{{ course.name }}</option>
                {% endfor %}
            </select>
            <button type="submit"
                    class="w-full sm:w-auto bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white px-6 py-3 rounded-lg font-semibold transition duration-300 ease-in-out shadow-lg transform hover:scale-105">
                Add Task
            </button>
        </form>

        <div class="relative">
            <button id="actions-dropdown-btn" type="button"
                    class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 py-3 rounded-lg font-semibold transition duration-300 ease-in-out shadow-lg transform hover:scale-105 flex items-center space-x-2">
                <span>Actions</span>
                <i class="fas fa-chevron-down text-sm"></i>
            </button>
            <div id="actions-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-amber-200 z-10">
                <button type="button" onclick="openImportModal()"
                        class="w-full text-left px-4 py-3 text-amber-800 hover:bg-amber-50 transition-colors duration-200 rounded-t-lg flex items-center space-x-2">
                    <i class="fas fa-upload text-sm"></i>
                    <span>Import Tasks</span>
                </button>
            </div>
        </div>
    </div>
    <div class="overflow-x-auto">
    <table class="table-auto w-full border-collapse border border-amber-300 bg-white/80 rounded-lg overflow-hidden shadow-lg">
        <thead>
            <tr class="bg-gradient-to-r from-amber-100 to-orange-100">
                <th class="border border-amber-300 px-2 py-2 sm:px-4 sm:py-3 text-amber-800 font-semibold text-sm sm:text-base">‚úÖ Done</th>
                <th class="border border-amber-300 px-2 py-2 sm:px-4 sm:py-3 text-amber-800 font-semibold text-sm sm:text-base">üìÖ Due Date</th>
                <th class="border border-amber-300 px-2 py-2 sm:px-4 sm:py-3 text-amber-800 font-semibold text-sm sm:text-base">üìù Description</th>
                <th class="border border-amber-300 px-2 py-2 sm:px-4 sm:py-3 text-amber-800 font-semibold text-sm sm:text-base">‚öôÔ∏è Actions</th>
            </tr>
        </thead>
        <tbody>
            {# Removed categorized sections to avoid duplication #}
             {% for category, course_groups in {'Missing': missing_assignments, 'Overdue': overdue, 'Due This Week': due_this_week, 'Due Next Week': due_next_week, 'Future': future}.items() %}
 <tr><td colspan="4" class="font-bold text-center py-4 text-white {% if category == 'Missing' %}bg-gradient-to-r from-red-600 to-pink-600{% elif category == 'Overdue' %}bg-gradient-to-r from-rose-400 to-red-400{% elif category == 'Due This Week' %}bg-gradient-to-r from-amber-400 to-orange-400{% elif category == 'Due Next Week' %}bg-gradient-to-r from-yellow-400 to-amber-400{% elif category == 'Future' %}bg-gradient-to-r from-emerald-400 to-teal-400{% endif %} shadow-sm">{{ category }}</td></tr>
{% for course_name in course_groups.keys()|sort %}
<tr><td colspan="4" class="font-semibold text-center py-2 text-amber-800 bg-gradient-to-r from-amber-100 to-orange-100 border-t border-amber-300">{{ course_name }}</td></tr>
{% for item in course_groups[course_name] %}
<tr class="{% if item['assignment_table'] %}bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100{% else %}bg-gradient-to-r from-amber-50 to-orange-50 hover:from-amber-100 hover:to-orange-100{% endif %} transition-all duration-200">
            
                <td class="border border-amber-200 px-2 py-2 sm:px-4 sm:py-3 text-center">
                    <input type="checkbox" {% if item.is_completed %}checked{% endif %} class="w-4 h-4 text-amber-600 bg-amber-100 border-amber-300 rounded focus:ring-amber-500 todo-checkbox" data-item-id="{{ item.id }}" data-item-type="{% if item.assignment_table %}assignment{% elif item.todo_table %}todo{% endif %}">
                </td>
                <td class="border border-amber-200 px-2 py-2 sm:px-4 sm:py-3 text-amber-700 text-sm sm:text-base">{{ item.due_date.strftime('%b %-d') if item.due_date else 'No due date' }}</td>
                <td class="border border-amber-200 px-2 py-2 sm:px-4 sm:py-3 text-amber-800 text-sm sm:text-base">{{ item.description if item.todo_table else item.name }}{% if item.assignment_table %} <span class="text-blue-600 font-semibold">- Max Score: {{ item.max_score }}</span>{% endif %}</td>
                <td class="border border-amber-200 px-2 py-2 sm:px-4 sm:py-3">
                    {% if item.todo_table %}
                        <div class="flex space-x-3 justify-center">
                            <button type="button" onclick="editTodo({{ item.id }}, '{{ item.description }}', '{{ item.due_date.strftime('%Y-%m-%d') if item.due_date else '' }}', {{ item.course_id if item.course_id else 'null' }})" 
                                    class="text-amber-600 hover:text-amber-800 transition-colors duration-200 transform hover:scale-110">
                                <i class="fas fa-edit text-lg"></i>
                            </button>
                            <form method="POST" action="{{ url_for('main.delete_todo_item', todo_id=item.id) }}" style="display: inline;" 
                                  onsubmit="return confirm('Are you sure you want to delete this todo item?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="text-rose-500 hover:text-rose-700 transition-colors duration-200 transform hover:scale-110">
                                    <i class="fas fa-trash-alt text-lg"></i>
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <span class="text-blue-500 text-sm font-medium px-2 py-1 bg-blue-100 rounded-full">üìö Assignment</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% endfor %}
        {% endfor %}
        </tbody>
    </table>
    </div>


<div id="assignment-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-4 sm:p-8 rounded-xl shadow-2xl w-full sm:w-1/3 border border-amber-200 mx-4">
        <h2 class="text-xl font-semibold mb-6 text-amber-800">üéØ Enter Assignment Score</h2>
        <form id="assignment-modal-form">
            <input type="hidden" name="assignment_id">
            <div class="mb-6">
                <label for="score" class="block text-sm font-medium text-amber-700 mb-2">Score</label>
                <input type="number" name="score" id="score" min="0" required
                       class="p-3 border border-amber-200 rounded-lg shadow-sm focus:ring-amber-400 focus:border-amber-400 sm:text-sm w-full bg-white/90">
            </div>
            <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                <button type="button" id="close-modal" class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-3 rounded-lg font-medium transition duration-200 shadow-md w-full sm:w-auto">Cancel</button>
                <button type="submit" class="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white px-6 py-3 rounded-lg font-medium transition duration-200 shadow-md w-full sm:w-auto">Submit</button>
            </div>
        </form>
    </div>
</div>

<div id="edit-todo-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-4 sm:p-8 rounded-xl shadow-2xl w-full sm:w-1/2 border border-amber-200 mx-4">
        <h2 class="text-xl font-semibold mb-6 text-amber-800">‚úèÔ∏è Edit ToDo Item</h2>
        <form id="edit-todo-form" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="todo_id" id="edit-todo-id">
            <div class="mb-6">
                <label for="edit-description" class="block text-sm font-medium text-amber-700 mb-2">Description</label>
                <input type="text" name="description" id="edit-description" required
                       class="p-3 border border-amber-200 rounded-lg shadow-sm focus:ring-amber-400 focus:border-amber-400 sm:text-sm w-full bg-white/90">
            </div>
            <div class="mb-6">
                <label for="edit-due-date" class="block text-sm font-medium text-amber-700 mb-2">Due Date</label>
                <input type="date" name="due_date" id="edit-due-date"
                       class="p-3 border border-amber-200 rounded-lg shadow-sm focus:ring-amber-400 focus:border-amber-400 sm:text-sm w-full bg-white/90">
            </div>
            <div class="mb-6">
                <label for="edit-course" class="block text-sm font-medium text-amber-700 mb-2">Course</label>
                <select name="course_id" id="edit-course" class="p-3 border border-amber-200 rounded-lg shadow-sm focus:ring-amber-400 focus:border-amber-400 sm:text-sm w-full bg-white/90">
                    <option value="">-- Select Course (Optional) --</option>
                    {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                <button type="button" id="close-edit-modal" class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-3 rounded-lg font-medium transition duration-200 shadow-md w-full sm:w-auto">Cancel</button>
                <button type="submit" class="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white px-6 py-3 rounded-lg font-medium transition duration-200 shadow-md w-full sm:w-auto">Update</button>
            </div>
        </form>
    </div>
</div>

<div id="import-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-4 sm:p-8 rounded-xl shadow-2xl w-full sm:w-1/2 border border-amber-200 mx-4">
        <h2 class="text-xl font-semibold mb-6 text-amber-800">üìã Import Tasks from List</h2>
        <form action="{{ url_for('main.import_todo_items') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="mb-6">
                <label for="import-bullet-list" class="block text-sm font-medium text-amber-700 mb-2">Paste your bullet point list here:</label>
                <textarea name="bullet_list" id="import-bullet-list" rows="8" placeholder="- Task 1&#10;- Task 2&#10;- Task 3" required
                          class="w-full p-3 border border-amber-200 rounded-lg shadow-sm focus:ring-amber-400 focus:border-amber-400 sm:text-sm bg-white/90 placeholder-amber-600"></textarea>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="import-due-date" class="block text-sm font-medium text-amber-700 mb-2">Due Date</label>
                    <input type="date" name="due_date" id="import-due-date"
                            class="w-full p-3 border border-amber-200 rounded-lg shadow-sm focus:ring-amber-400 focus:border-amber-400 sm:text-sm bg-white/90">
                </div>
                <div>
                    <label for="import-course-id" class="block text-sm font-medium text-amber-700 mb-2">Course</label>
                    <select name="course_id" id="import-course-id" class="w-full p-3 border border-amber-200 rounded-lg shadow-sm focus:ring-amber-400 focus:border-amber-400 sm:text-sm bg-white/90">
                        <option value="">-- Select Course (Optional) --</option>
                        {% for course in courses %}
                        <option value="{{ course.id }}">{{ course.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                <button type="button" id="close-import-modal" class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-3 rounded-lg font-medium transition duration-200 shadow-md w-full sm:w-auto">Cancel</button>
                <button type="submit" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-6 py-3 rounded-lg font-medium transition duration-200 shadow-md w-full sm:w-auto">Import Tasks</button>
            </div>
        </form>
    </div>
</div>
</div>
{% endblock %}
