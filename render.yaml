# ===========================================
# Render.com Deployment Configuration
# ===========================================
# This configuration deploys the Flask Grade Tracker on Render.com
# 
# Usage: Push this file to your repo root and Render will auto-detect it
# See: https://render.com/docs/infrastructure-as-code
#
# NOTE: PostgreSQL and Redis services must be created manually in the Render Dashboard
#       This file defines the web service only
#       The database and cache services can be added via Dashboard

services:
  # ===========================================
  # WEB SERVICE
  # ===========================================
  - type: web
    name: gradetracker
    runtime: docker
    dockerfilePath: ./Dockerfile.render
    dockerContext: ./
    
    # Auto-scaling configuration
    plan: standard
    scaling:
      minInstances: 1
      maxInstances: 3
      targetMemoryPercent: 70
      targetCPUPercent: 80
    
    # Environment variables
    envVars:
      - key: FLASK_ENV
        value: production
      - key: FLASK_APP
        value: app.py
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PYTHONDONTWRITEBYTECODE
        value: "1"
      - key: LOG_LEVEL
        value: INFO
      - key: USE_HTTPS
        value: "true"
      - key: SESSION_COOKIE_SECURE
        value: "true"
    
    # Health check endpoint
    healthCheckPath: /health
    
    # Start command - gunicorn with gevent workers
    startCommand: >
      gunicorn
      --bind 0.0.0.0:5000
      --workers 3
      --worker-class gevent
      --timeout 120
      --access-logfile -
      --error-logfile -
      app:app

# ===========================================
# SETUP INSTRUCTIONS
# ===========================================
#
# STEP 1: Create PostgreSQL Database
# ───────────────────────────────────
# 1. Go to https://dashboard.render.com
# 2. Click "New" → "PostgreSQL"
# 3. Name: gradetracker-db
# 4. Database: gradetracker
# 5. User: gradetracker_user
# 6. Region: US East (or your preferred region)
# 7. Click "Create Database"
# 8. Copy the External Database URL
#
# STEP 2: Create Redis Cache
# ──────────────────────────
# 1. Click "New" → "Redis"
# 2. Name: gradetracker-redis
# 3. Region: US East (same as DB)
# 4. Eviction Policy: allkeys-lru
# 5. Click "Create Redis"
# 6. Copy the Redis URL
#
# STEP 3: Create Web Service
# ──────────────────────────
# 1. Click "New" → "Web Service"
# 2. Connect your GitHub repository
# 3. Select branch: main
# 4. Name: gradetracker
# 5. Runtime: Docker (auto-detected)
# 6. Render will find this render.yaml file
# 7. Click "Create Web Service"
#
# STEP 4: Set Environment Variables
# ──────────────────────────────────
# Go to your service settings and add:
#
# REQUIRED (set as Secrets for security):
#   - FLASK_SECRET_KEY: Generate with:
#     python -c "import secrets; print(secrets.token_hex(32))"
#   - API_TOKEN_ENCRYPTION_KEY: Your existing key
#   - DATABASE_URL: Paste the PostgreSQL External URL from Step 1
#   - REDIS_URL: Paste the Redis URL from Step 2
#
# OPTIONAL:
#   - MAIL_USERNAME: Your email address
#   - MAIL_PASSWORD: Your email password
#
# STEP 5: Deploy
# ──────────────
# Click "Deploy" or wait for auto-deploy after pushing to GitHub
# Render will build the Docker image and start your service
#
# ===========================================
# ENVIRONMENT VARIABLES REFERENCE
# ===========================================
#
# DATABASE_URL
#   Description: PostgreSQL database connection string
#   Format: postgresql://user:password@host:5432/database
#   Source: Copy from PostgreSQL service details
#
# REDIS_URL
#   Description: Redis cache connection string
#   Format: redis://:password@host:port
#   Source: Copy from Redis service details
#
# FLASK_SECRET_KEY
#   Description: Secret key for Flask session signing
#   Value: Must be random, generate with Python
#   Importance: CRITICAL - use strong random value
#
# API_TOKEN_ENCRYPTION_KEY
#   Description: Key for encrypting Canvas API tokens
#   Value: Your existing encryption key
#   Importance: CRITICAL - don't lose this!
#
# MAIL_USERNAME / MAIL_PASSWORD
#   Description: Email credentials for sending notifications
#   Optional: Only needed if using email features
#
# ===========================================
# TROUBLESHOOTING
# ===========================================
#
# "Health check failing"
#   - Ensure /health endpoint exists in Flask app
#   - Check DATABASE_URL and REDIS_URL are set correctly
#   - Review logs in Render Dashboard
#
# "Database connection refused"
#   - Verify DATABASE_URL is correctly set
#   - Wait for PostgreSQL service to fully initialize (2-3 minutes)
#   - Check that database service is running
#
# "Redis connection refused"
#   - Verify REDIS_URL is correctly set
#   - Wait for Redis service to fully initialize
#   - Check that Redis service is running
#
# "Application crashes on startup"
#   - Check FLASK_SECRET_KEY is set (not empty)
#   - Verify all required environment variables are set
#   - Review application logs in Render Dashboard
#
# ===========================================
# COSTS
# ===========================================
#
# Web Service (Standard):    $12/month
# PostgreSQL (Starter):      $7/month
# Redis (Starter):           $6/month
# ────────────────────────────────────
# Total:                     ~$25/month
#
# Upgrade plans for better performance:
#   Web Service Pro:    $25/month (more CPU/RAM)
#   PostgreSQL Std:     $50/month (more storage/connections)
#   Redis Std:          $30/month (more memory)
#
# ===========================================
# MONITORING & LOGS
# ===========================================
#
# View Logs:
#   1. Go to https://dashboard.render.com
#   2. Select your service
#   3. Click "Logs" tab
#   4. See application output and errors
#
# Monitor Performance:
#   1. Select your service
#   2. Click "Metrics" tab
#   3. View CPU, Memory, and Network usage
#   4. Set up alerts if needed
#
# ===========================================
